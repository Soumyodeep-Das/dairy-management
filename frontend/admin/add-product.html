<!DOCTYPE html>
<html>
<head>
  <title>Add Product - Dairy Fresh</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <div class="header-bar">Dairy Fresh Admin</div>
  <div style="display: flex; align-items: center; justify-content: center; min-height: 70vh; width: 100vw;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 480px;">
      <h1 style="margin-bottom: 10px; text-align: center;">Add New Product</h1>
      <form id="addProductForm" style="width: 100%; max-width: 400px;">
        <input type="text" id="name" placeholder="Product Name" required />
        <input type="text" id="category" placeholder="Category" required />
        <input type="number" step="0.01" id="price" placeholder="Price" required />
        <input type="number" id="quantity" placeholder="Quantity" required />
        <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">Add Product</button>
        <div class="form-feedback" id="addProductFeedback"></div>
      </form>
      <a href="dashboard.html" style="margin-top: 18px; text-align: center;">Back to Dashboard</a>
    </div>
  </div>

  <script type="module">
    window.addEventListener("pageshow", function(event) {
      if (event.persisted) window.location.reload();
    });
    import { postData } from "../js/api.js";
    import { qs } from "../js/utils.js";
    import { getUserSession } from "../js/auth.js";

    const form = qs("#addProductForm");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = qs("#name").value.trim();
      const category = qs("#category").value.trim();
      const price = parseFloat(qs("#price").value);
      const quantity = parseInt(qs("#quantity").value);
      const feedback = qs("#addProductFeedback");
      feedback.textContent = "";

      if (!name || !category || isNaN(price) || isNaN(quantity)) {
        feedback.textContent = "Please fill all fields correctly.";
        return;
      }

      const formData = {
        name,
        category,
        price,
        stock: quantity,
        description: '',
        ratings: 5,
        expiry_date: '',
        image: ''
      };

      try {
        const res = await fetch("../../backend/admin/add_product.php", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(formData).toString()
        });
        const data = await res.json();

        if (data.status === "success") {
          feedback.textContent = "Product added successfully.";
          feedback.classList.add("form-success");
          setTimeout(() => window.location.href = "dashboard.html", 1200);
        } else {
          feedback.textContent = data.message || "Add product failed.";
        }
      } catch (error) {
        feedback.textContent = "Server error: Failed to add product.";
      }
    });
  </script>
</body>
</html>
